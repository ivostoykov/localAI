var controller,laiOptions,shouldAbort=!1;function fetchUserCommandResult(e,t){return new Promise(((n,o)=>{switch(e){case"page":chrome.scripting.executeScript({target:{tabId:t.tab.id},function:extractEnhancedContent},(e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):n(e?.[0]?.result??"")}));break;case"url":n(t.url);default:n("")}}))}function extractEnhancedContent(){const e=document.body.cloneNode(!0);["script","style","code","header","footer","nav","aside","form","iframe","video",'[id*="ad"]','[class*="sidebar"]','[class*="ad"]','[class*="side-nav"]',".sidebar",".widget"].forEach((t=>{e.querySelectorAll(t).forEach((e=>e.remove()))}));const t=e=>{for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];8===o.nodeType||3===o.nodeType&&!/\S/.test(o.nodeValue)?(e.removeChild(o),n--):1===o.nodeType&&t(o)}};return t(e),e.textContent.trim()}function handleStreamingResponse(e,t){if(!e||!e.read)return;const n=()=>{if(shouldAbort)return e.cancel(),void chrome.tabs.sendMessage(t,{action:"streamAbort"});e.read().then((({done:e,value:o})=>{if(e)return void chrome.tabs.sendMessage(t,{action:"streamEnd"});const s=(new TextDecoder).decode(o);chrome.tabs.sendMessage(t,{action:"streamData",data:s}),n()})).catch((e=>{shouldAbort||chrome.tabs.sendMessage(t,{action:"streamError",error:e.toString()})}))};n()}function updateSystemMessageDate(e){let t=e.findIndex((e=>"system"===e.role));const n=laiOptions?.systemInstructions||"";t<0&&(e.unshift({role:"system",content:""}),t=0);const o=`[local date and time: ${new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toISOString()}]`;return e[t].content?e[t].content.indexOf("[local date and time: ")<0?e[t].content+=` ${o}`:e[t].content=e[t].content.replace(/\[local date and time: \d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d{1,3}Z\]/gm,o):e[t].content=`${n} ${o}`,e[t].content=addPersonalInfoToSystemMessage(e[t].content),e}async function fetchDataAction(e,t){const n=new AbortController;let o=e?.data?.messages||[],s=o.slice(-1)[0]?.content||"";s=await laiComposeUerImput(s,t),e.data.messages.splice(-1,1,{role:"user",content:s}),o=updateSystemMessageDate(o);const r=`http://localhost:${e.port}${e.path}`;fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.data),signal:n.signal}).then((e=>{if(shouldAbort&&n)return n.abort(),void chrome.tabs.sendMessage(senderTabId,{action:"streamAbort"});handleStreamingResponse(e?.body?.getReader(),t.tab.id)})).catch((e=>{"AbortError"===e.name?chrome.tabs.sendMessage(t.tab.id,{action:"streamAbort"}):chrome.tabs.sendMessage(t.tab.id,{action:"streamError",error:e.toString()}),delete n}))}async function laiComposeUerImput(e,t){if(!e)return"";var n=[];const o=[...e.matchAll(/@\{\{([\s\S]+?)\}\}/gm)];if(o.length<1)return e;for(const s of o)if(s&&s.length>1&&s[1]){const o=await fetchUserCommandResult(s[1],t);n.push(`This is the content of the >${s[1]}<:\n${o}`),e=e.replace(`@{{${s[1]}}}`,"")}return n.push(e),n.join("\n")}function addPersonalInfoToSystemMessage(e){if(!e)return e;const t=getPersonalInfo();if(!t)return e;let n="";try{n=JSON.stringify(t)}catch(e){n=""}return e.indexOf("[personal information:")<0?e+=` [personal information: ${n}]`:e=e.replace(/\s{0,}\[personal information: .*?\]/gm,` [personal information: ${n}]`),e}function getPersonalInfo(){if(!laiOptions||Object.keys(laiOptions)<1)return;if(!laiOptions.personalInfo)return;const e={};return laiOptions.personalInfo.split(/;|\n/).forEach((t=>{const[n,o]=t.split(/[\s;,-:](.*)/s).filter(Boolean);e[n.trim()]=o.trim()})),e}function getOptions(){return new Promise(((e,t)=>{const n={openPanelOnLoad:!1,localPort:"1234",chatHistory:25,closeOnClickOut:!0,closeOnCopy:!1,closeOnSendTo:!0,showEmbeddedButton:!1,systemInstructions:"",personalInfo:""};chrome.storage.sync.get("laiOptions",(function(o){if(chrome.runtime.lastError)return t(chrome.runtime.lastError);const s=Object.assign({},n,o.laiOptions);e(s)}))}))}chrome.tabs.onUpdated.addListener((async(e,t,n)=>{n.url&&!n.url.startsWith("http")||"complete"===t.status&&n.url&&(laiOptions=await getOptions())})),chrome.action.onClicked.addListener((e=>{e.url.startsWith("http")&&chrome.tabs.sendMessage(e.id,{action:"toggleSidebar"})})),chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(controller||(controller=new AbortController),e.action){case"fetchData":shouldAbort=!1,fetchDataAction(e,t);break;case"abortFetch":shouldAbort=!0;break;case"openOptionsPage":chrome.tabs.create({url:chrome.runtime.getURL("options.html")});break;default:}return!0})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"sendToLocalAi",title:"Local AI",contexts:["all"]}),chrome.contextMenus.create({id:"selectElement",title:"Select and Send Element",parentId:"sendToLocalAi",contexts:["all"]}),chrome.contextMenus.create({id:"sendSelectedText",title:"Send Selected",parentId:"sendToLocalAi",contexts:["selection"]}),chrome.contextMenus.create({id:"sendPageContent",title:"Entire Page",parentId:"sendToLocalAi",contexts:["all"]})})),chrome.contextMenus.onClicked.addListener(((e,t)=>{switch(e.menuItemId){case"sendSelectedText":if(!e.selectionText.length)return;if(!t.id)return;chrome.tabs.sendMessage(t.id,{action:"activePageSelection",selection:e.selectionText});break;case"sendPageContent":t.id&&chrome.scripting.executeScript({target:{tabId:t.id},function:extractEnhancedContent},(e=>{const n=e?.[0]?.result??"";n&&chrome.tabs.sendMessage(t.id,{action:"activePageContent",selection:n})}));break;case"selectElement":if(!t.id)return;chrome.tabs.sendMessage(t.id,{action:"toggleSelectElement",selection:!0});break;default:}}));