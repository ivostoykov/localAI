const laiWordEndings = /(?:\w+'(?:m|re|ll|s|d|ve|t))\s/;  // 'm, 're, 's, 'd, 'll, 've, 't
const laiWordFormations = /(?:'(?:clock|til|bout|cause|em))/; // 'clock, 'til, 'bout, 'cause, 'em

function laiInitSidebar() {
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    shadowRoot.getElementById('laiUserInput').addEventListener('keyup', onLaiTextAreaKeyUp);
    shadowRoot.getElementById('laiUserInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.code !== 'NumpadEnter' && !e.shiftKey) {
            e.preventDefault();
        }
    });
    shadowRoot.querySelector('.lai-cog-menu-button')?.addEventListener('click', function (e) {
        chrome.runtime.sendMessage({action: "openOptionsPage"});
    });

    shadowRoot.getElementById('laiRecycleAll').addEventListener('click', function(e) {
        shadowRoot.getElementById('laiChatMessageList').innerHTML = '';
        messages = [];
        currentStreamData = '';
    });

    shadowRoot.querySelector('.lai-close-button')?.addEventListener('click', function (e) {
        const pinned = shadowRoot.getElementById('laiPinned');
        const pinImg = pinned.querySelector('img[data-type="black_pushpin"]');
        const isPinned = !pinImg.classList.contains('lai-invisible');
        if(isPinned) {
            pinImg?.click();
        }
        laiSwapSidebarWithButton(true);
    });

    shadowRoot.getElementById('laiAbort').addEventListener('click', laiAbortRequest);
    if(laiOptions && laiOptions.openPanelOnLoad){
        // laiSwapButtonWithSidebar();
        laiSwapSidebarWithButton();
    }

    shadowRoot.getElementById('laiSysIntruct').querySelectorAll('img').forEach(el => {
        laiSetImg(el);
        el.addEventListener('click', laiShowSystemInstructions);
    });

    const sysIntructInput = shadowRoot.querySelector('#laiSysIntructInput');
    sysIntructInput.value = laiOptions.systemInstructions || '';
    sysIntructInput.addEventListener('change', function(e){
        const value = e.target.value;
        if (!value) {
            return;
        }

        const index = messages.findIndex(message => message.role === "system");
        if (index !== -1) {
            messages[index].content += value;
        } else {
            messages.push({ role: "system", content: value });
        }
    });

    shadowRoot.getElementById('laiPinned').querySelectorAll('img').forEach(el => {
        laiSetImg(el);
        el.addEventListener('click', laiPushpinClicked);
    });

    const laiChatMessageList = shadowRoot.getElementById('laiChatMessageList');
    laiChatMessageList.addEventListener('scroll', () => {
        const fromBottom = laiChatMessageList.scrollHeight - laiChatMessageList.scrollTop - laiChatMessageList.clientHeight;
        userScrolled = fromBottom > 10 ? true : false;
    });

    const resizeHandle = shadowRoot.querySelector('.lai-resize-handle');
    laiSetImg(resizeHandle.querySelector('img'));

    resizeHandle.addEventListener('mousedown', function(e) {
      laiResizeContainer(e/* , resizableDiv */);
    });
};

function laiShowSystemInstructions(e){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const sysIntructContainer = shadowRoot.getElementById('laiSysIntructContainer');
    const sysIntructInput = sysIntructContainer.querySelector('#laiSysIntructInput');
    sysIntructContainer.classList.toggle('active');
    if(sysIntructContainer.classList.contains('active')) {
        sysIntructInput.focus();
    }
}

function laiPushpinClicked(e) {
    const container = e.target.closest('div');
    let isPinned = false;

    container.querySelectorAll('img').forEach(img => {
        img.classList.toggle('lai-invisible');
        if (img.getAttribute('data-type') === 'black_pushpin') {
            isPinned = !img.classList.contains('lai-invisible');
        }
    });

    laiOptions.closeOnClickOut = !isPinned;
    console.log(`laiOptions.closeOnClickOut set to ${laiOptions.closeOnClickOut}`);
}

function onLaiTextAreaKeyUp(e) {

    if (e.key === 'Enter' && e.code !== 'NumpadEnter' && !e.shiftKey) {
        e.preventDefault();
        const shadowRoot = document.getElementById('localAI').shadowRoot;
        shadowRoot.getElementById('laiSysIntructContainer').classList.remove('active');
        if((messages.length + 1) > laiOptions.chatHistory){
            messages.split(1, 1);
        }
        const idx = messages.push({ "role": "user", "content": e.target.value });
        laiUpdateChatHistoryWithUserInput(e.target.value, 'user', idx-1);
        laiUpdateChatHistoryWithUserInput('', 'ai');
        laiQueryAI(e.target.value);
        e.target.value = '';
        e.target.classList.add('lai-invisible');
        shadowRoot.getElementById('laiAbort')?.classList.remove('lai-invisible');
    }
}

function transformTextInHtml(inputText){
    const lastChatText = document.createElement('span');
    lastChatText.className = "lai-input-text";

    const lines = inputText.split(/\n/).map(line => document.createTextNode(line));
    lines.forEach((line, index) => {
        lastChatText.appendChild(line);
        if (index < lines.length - 1) {
            lastChatText.appendChild(document.createElement('br'));
        }
    });

    return lastChatText;
}

function laiUpdateChatHistoryWithUserInput(inputText, type, index=-1){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const chatHist = shadowRoot.getElementById('laiChatMessageList');
    const lastChatElement = Object.assign(document.createElement('div'), {
        className: `lai-${type}-input lai-chat-history`
    });

    if(type === 'ai'){
        shadowRoot.querySelector('#laiPreviousAiInput')?.removeAttribute('id');
        shadowRoot.querySelectorAll("#laiActiveAiInput")?.forEach(el => {
            el?.removeAttribute("id");
        });
    }
    const lastChatlabel = Object.assign(document.createElement('span'), {
        className: "lai-input-label",
        innerHTML: `${type === 'ai' ? type.toUpperCase() : type}:&nbsp;`
    });
    const lastChatText = transformTextInHtml(inputText);
    let buttons = '<span class="lai-delete-chat-item-action" data-type="delete"></span><span class="lai-copy-chat-item-action" data-type="copy"></span>';
    if(type !== 'ai' && index > -1){
        buttons += `<span class="lai-edit-item-action" data-type="edit" data-index=${index}><img src="${chrome.runtime.getURL('img/edit.svg')}"></span>`;
    }
    const actionIconsDiv = Object.assign(document.createElement('div'), {
        // id: `${type === 'ai' ? 'laiActiveAiInput' : ''}`,
        className: 'lai-action-icons',
        innerHTML: buttons
    });

    lastChatElement.appendChild(lastChatlabel)
    lastChatElement.appendChild(lastChatText)
    lastChatElement.appendChild(actionIconsDiv);
    chatHist.appendChild(lastChatElement);

    lastChatElement.querySelectorAll('.lai-copy-chat-item-action, .lai-delete-chat-item-action, .lai-edit-item-action').forEach(el => {
        el.addEventListener('click', function(e) {
            let action = e.target.getAttribute('data-type');
            if(!action) {
                action = e.target.parentElement.getAttribute('data-type');
            }
            if(!action) {  return;  }
            switch (action) {
                case 'copy':
                    laiCopyElementContent(e, type);
                    // navigator.clipboard.writeText(e.target.closest(`.lai-${type}-input`)?.querySelector('.lai-input-text')?.textContent || '');
                    break;
                case 'delete':
                    e.target.closest(`.lai-${type}-input`)?.remove();
                    break;
                case 'edit':
                    editUserInput(e, type);
                    break;
                default:
                    break;
            }
        });
    });
// redundant?
    if(type === 'ai'){
        lastChatText.addEventListener('click', function(e){  laiSourceTextClicked(e);  });
    }

    chatHist.scrollTop = chatHist.scrollHeight;
}

function laiShowCopyHint(e){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const hint = shadowRoot.getElementById('laiCopyHint');

    hint.style.right = '';
    hint.style.left = '';
    hint.style.opacity = 0;
    hint.classList.remove('lai-invisible');

    var hintWidth = hint.offsetWidth;
    var viewportWidth = window.innerWidth;

    // Calculate available space on the left and right
    var spaceOnLeft = e.clientX;
    var spaceOnRight = viewportWidth - e.clientX;

    if (spaceOnRight < hintWidth + 20 && spaceOnLeft >= hintWidth + 20) {
      hint.style.right = (viewportWidth - e.clientX - 20) + 'px';
      hint.style.left = 'auto';
    } else {
      hint.style.left = Math.min(e.clientX, viewportWidth - hintWidth - 20) + 'px';
      hint.style.right = 'auto';
    }

    hint.style.top = e.clientY + 'px';

    setTimeout(() => hint.style.opacity = 1, 10);  // Show the hint with a slight delay for opacity transition

    setTimeout(function() {
      hint.style.opacity = 0;
      hint.classList.add('lai-invisible');
    }, 2500);
  }

function laiCopyElementContent(e, type){
    const element = e.target.closest(`.lai-${type}-input`)?.querySelector('.lai-input-text');

      let htmlContent = element.innerHTML;
      const modifiedHtml = htmlContent.replace(/<br\s*\/?>/gi, '\n');

      const tempElement = document.createElement('div');
      tempElement.innerHTML = modifiedHtml;

      const textToCopy = tempElement.textContent;

      navigator.clipboard.writeText(textToCopy)
        .then(() => laiShowCopyHint(e))
        .catch(err => console.error('Failed to copy text: ', err));
}

function editUserInput(e, type){
    let el = e.target.closest('span[data-index]');
    const idx = el.getAttribute('data-index') || -1;
    if(idx < 0){  return;  }
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const userInputField = shadowRoot.getElementById('laiUserInput')
    userInputField.value = messages[idx].content;
}

// handle code snippets clicks in AI response
function laiSourceTextClicked(e){
    const clickedSourceTitle = e.target.closest('.lai-source-title');
    if(!clickedSourceTitle) {  return;  }
    const thePre = clickedSourceTitle.closest('pre');
    if(!thePre){  return;  }
    const theCode = thePre.cloneNode(true);
    theCode.querySelector('span')?.remove();
    const textToCopy = theCode.innerHTML.replace(/<br\s*\/?>/gi, '\n');

    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            clickedSourceTitle.classList.toggle('copied');
            setTimeout(() => clickedSourceTitle.classList.toggle('copied'), 3000);
        })
        .catch(err => console.error('Failed to copy text: ', err));
}

function laiSwapSidebarWithButton(forceClose = false) {
  const shadowRoot = document.getElementById('localAI').shadowRoot;
    const slideElement = shadowRoot.getElementById('laiSidebar');
    if(!slideElement){
        console.error('Slidebar not found!');
        return;
    }

    laiUpdateMainButtonStyles();

    const isSidebarActive = slideElement.classList.contains('active');
    if(!forceClose && isSidebarActive && !laiOptions?.closeOnClickOut){  return;  }
    slideElement.classList.toggle('active');
    if(slideElement.classList.contains('active')){
        slideElement.querySelector('textarea#laiUserInput').focus();
    }
}

function laiUpdateMainButtonStyles(){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    var btn = shadowRoot.getElementById('laiMainButton');
    if(!btn){
        console.error('Main button not found!');
        return;
    }

    const isButtonVisible = !btn.classList.contains('lai-invisible');

    if(!isButtonVisible && laiOptions?.showEmbeddedButton){ // if not visible but should be - show it
        btn.classList.toggle('lai-invisible');
    } else {
        btn.classList.toggle('lai-invisible'); // hide if visible
    }
}

function laiOnRibbonButtonClick(e) {
    e.stopPropagation();
    e.preventDefault();
    const clickedButton = this || e.target;
    const type = clickedButton.getAttribute('data-type').toLowerCase();
    if (!type) { return; }
    switch (type) {
        default:
            laiShowMessage(`Unknown type ${type}`);
    }
}

function laiAbortRequest(e) {
    chrome.runtime.sendMessage({action: "abortFetch"}, () => {
        console.log("Abort message sent");
    });
}


function laiQueryAI(inputText) {

    const requestData = {
        action: "fetchData",
        port: laiOptions.localPort || '1234',
        path: '/v1/chat/completions',
        data: {
            "messages": messages,
            "temperature": 0.5,
            "max_tokens": 1024,
            "stream": true
        }
    };

    chrome.runtime.sendMessage(requestData, (response) => {
        if (response?.error) {
            console.error("Fetch error:", response.error);
        // } else {
            // console.log("Data:", response.data);
        }
    });
}

function laiSetModelName(data){
    if(!data) {  return;  }
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const modelName = shadowRoot.getElementById('laiModelName');
    const model = data?.model;
    if(!model) {  return;  }
    modelName.textContent = model.split(/\\|\//).pop().split('.').slice(0,-1).join('.');
}

function laiFinalPreFormat(){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const chatList = shadowRoot.getElementById('laiChatMessageList');
    if(!chatList) {  return;  }

    chatList.querySelectorAll('pre.lai-source').forEach(preElement => {
        const replacedHtml = preElement.innerHTML.replace(/<code class="lai-code">(.*?)<\/code>/g, "'$1'");
        preElement.innerHTML = replacedHtml.replace(/<br\/?>/g, '\n');
  });
}

function laiExtractDataFromResponse(response){
    const parts = (response?.data?.split(': ') || []).slice(-1);
    const jsonPart = parts[0];
    if(jsonPart.toUpperCase() === '[DONE]') {  return;  }
    let data = '';
    try {
        data = JSON.parse(jsonPart);
    } catch (err) {
        throw err;
    }

    laiSetModelName(data);
    return (data?.choices?.[0]?.delta?.content || '');
}

chrome.runtime.onMessage.addListener((response) => {
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    let recipient = shadowRoot.getElementById('laiActiveAiInput');
    if(!recipient){
        recipient = Array.from(shadowRoot.querySelectorAll('.lai-ai-input .lai-input-text')).pop();
        recipient?.setAttribute("id", "laiActiveAiInput");
    }
    if(!recipient && ['toggleSidebar', 'activePageSelection', 'activePageContent', 'toggleSelectElement'].indexOf(response.action) < 0){
        console.log("no recipient");
        return;
    }

    switch (response.action) {
        case "streamData":

            try {
                let dataChunk = laiExtractDataFromResponse(response);
                if(!dataChunk) {  return;  }
                StreamMarkdownProcessor.processStreamChunk(dataChunk, laiGetRecipient);
                // laiProcessResponseDataChunk(dataChunk);
            } catch (err) {
                laiHandleStreamActions(`${err}`, recipient)
                console.error(err);
                console.log(response);
            }
            break;
        case "streamEnd":
            laiHandleStreamActions("Stream Ended", recipient);
            break;
        case "streamError":
            laiHandleStreamActions("Stream Error", recipient);
            break;
        case "streamAbort":
            laiHandleStreamActions("Stream Aborted", recipient, '... Aborted');
            break;
        case "toggleSidebar":
            laiSwapSidebarWithButton(true);
            break;
        case "activePageSelection":
            laiAppendSelectionToUserImput(response.selection);
            break;
        case "activePageContent":
            laiAppendSelectionToUserImput(response.selection.replace(/\s{1,}/gm, ' '));
            break;
        case "toggleSelectElement":
            isElementSelectionActive = response.selection;
            break;
        default:
            laiHandleStreamActions(`Unknown action: ${response.action}`, recipient);
            break;
    }

    if (!userScrolled) {
        const laiChatMessageList = shadowRoot.getElementById('laiChatMessageList');
        laiChatMessageList.scrollTop = laiChatMessageList.scrollHeight;
    }
});

function laiHandleStreamActions(logMessage, recipient, abortText = '') {
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    let textAres = shadowRoot.getElementById('laiUserInput');
    console.log(logMessage);
    const laiAbortElem = shadowRoot.getElementById('laiAbort');
    recipient.removeAttribute("id");
    currentStreamData = ''; // obsolate
    const streamData = StreamMarkdownProcessor.getRawContent();

    if (laiAbortElem) laiAbortElem.classList.add('lai-invisible');
    if (textAres) {
        textAres.classList.remove('lai-invisible');
        textAres.focus();
    } else {
        console.error('User input area not found!');
    }

    if (streamData) {
        messages.push({"role": "assistant", "content": streamData});
        if(messages.length > laiOptions.chatHistory){
            messages.split(1, 1);
        }
    }

    if (abortText && recipient) {
        recipient.innerHTML += `<span class="lai-aborted-text">${abortText}</span>`;
    }

    console.log(StreamMarkdownProcessor.log());
    console.log(StreamMarkdownProcessor.dumpAsString());
    StreamMarkdownProcessor.dispose();
}

function laiCloseActiveTag(char, recipient){
    recipient.removeAttribute("id");
    recipient = recipient.closest('#laiPreviousAiInput');
    recipient.setAttribute("id", "laiActiveAiInput");
    return recipient;
}

function laiSwitchToCodeTag(char, recipient){
    recipient.setAttribute("id", "laiPreviousAiInput");
    const code = Object.assign(document.createElement('code'), {
        id: "laiActiveAiInput",
        className: 'lai-code',
        // innerHTML: inCodeTag ? '' : char === '\n' ? '<br/>' : char
    });
    recipient.innerHTML += code.outerHTML;
    return recipient.querySelector('#laiActiveAiInput');
}

// function laiSwitchToPreTag(char, recipient){
//     recipient.setAttribute("id", "laiPreviousAiInput");
//     const pre = Object.assign(document.createElement('pre'), {
//         id: "laiActiveAiInput",
//         className: 'lai-source',
//         innerHTML: `<span class="lai-source-title">Code</span>\n`
//     });
//     recipient.innerHTML += pre.outerHTML;
//     return recipient.querySelector('#laiActiveAiInput');
// }

// function laiSwitchToBoldOrItalicsOrH(tagName, char, recipient){
//     recipient.setAttribute("id", "laiPreviousAiInput");
//     recipient.innerHTML += `<${tagName} id="laiActiveAiInput"></${tagName}>`;
//     return recipient.querySelector('#laiActiveAiInput');
// }

function laiGetRecipient(){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    let recipient = shadowRoot.querySelector('#laiActiveAiInput');
    if(!recipient){  recipient = shadowRoot.querySelectorAll('span.lai-ai-input');  }
    if(!recipient){  throw Error('No recipient found!');  }
    return recipient;
}

// function laiChangeRecipient(char, recipient, recipientTagName){
//     if(recipientTagName.charAt(0) === 'h' && char === '\n'){
//         return laiCloseActiveTag(char === '\n' ? '' : char, recipient);
//     }

//     const last6StreamChars = currentStreamData.slice(-6);
//     let last3StreamChars = last6StreamChars.slice(-3);

//     if(last3StreamChars !== "'''" && last3StreamChars !== "```" && recipientTagName === 'pre'){
//         return recipient;
//     }

//     if((last3StreamChars.endsWith("/*") || last3StreamChars.endsWith("*/")) && recipientTagName === 'pre'){
//         return recipient;
//     }

//     if(last6StreamChars.indexOf('#') > -1){
//         if(/\s$/.test(char)) {
//             return laiSwitchToBoldOrItalicsOrH(`h${(last6StreamChars.match(/#*$/) || []).length}`, char, recipient);
//         } else {
//             return recipient;
//         }
//     }

//     let bold = last3StreamChars.lastIndexOf('**') > -1 || last3StreamChars.lastIndexOf('__') > -1;
//     if(bold){
//         if(recipientTagName === 'b'){
//             return laiCloseActiveTag(char === '\n' ? '' : char, recipient);
//         } else {
//             return laiSwitchToBoldOrItalicsOrH('b', char, recipient);
//         }
//     }

//     let italics = last3StreamChars.lastIndexOf('*') > -1 || last3StreamChars.lastIndexOf('_') > -1;
//     if(italics){
//         if(recipientTagName === 'i'){
//             return laiCloseActiveTag(char === '\n' ? '' : char, recipient);
//         } else {
//             return laiSwitchToBoldOrItalicsOrH('i', char, recipient);
//         }
//     }

//     switch (last3StreamChars) {
//         case '```':
//         case "'''":
//             if(recipientTagName === 'pre'){
//                 return laiCloseActiveTag(char === '\n' ? '' : char, recipient);
//             } else {
//                 return laiSwitchToPreTag(char === '\n' ? '' : char, recipient);
//             }
//             break;
//     }
// // single tick left
//     last3StreamChars += char;
//     if (laiWordFormations.test(last3StreamChars)) {
//         if(recipient.innerHTML.slice(-1) !== currentStreamData.slice(-1)){
//             recipient.innerHTML += currentStreamData.slice(-1);
//         }
//         return recipient;
//     }
//     if (laiWordEndings.test(last3StreamChars)) {
//         if(recipient.innerHTML.slice(-1) !== currentStreamData.slice(-1)){
//             recipient.innerHTML += currentStreamData.slice(-1);
//         }
//         return recipient;
//     }

//     if(recipientTagName === 'code'){
//         recipient = laiCloseActiveTag(char, recipient);
//     } else {
//         recipient = laiSwitchToCodeTag(char, recipient);
//     }

//     return recipient;
// }

// function laiFixWrondCodeTag(recipient){
//     const codeHtml = recipient.innerHTML;
//     recipient = recipient.closest('#laiPreviousAiInput');
//     recipient.querySelector("#laiActiveAiInput").remove();
//     recipient.setAttribute("id", "laiActiveAiInput");
//     recipient.innerHTML += `'${codeHtml}`;
//     return recipient;
// }

// function laiCleanFromTriggerSymbols(html, activeTagName){
//     if(activeTagName === 'pre'){
//         return html.replace(/[`']{1,}$/, '');
//     }

//     if(/#\s/.test(html)){
//         return html;
//     }

//     return html.replace(/[`'#*_]{1,}$/, '');
// }

// function laiProcessResponseDataChunk(dataChunk) {
//     let recipient = laiGetRecipient();
//     let recipientTagName = recipient.tagName.toLowerCase();
//     const triggerChars = "`'#*_";

//     dataChunk.split('').forEach(char => {
//         const rawChar = char;
//         const lastStreamChar = currentStreamData.slice(-1);

//         // trigger chars just passed and current is an ordinary char
//         if((lastStreamChar && triggerChars.indexOf(lastStreamChar) > -1 && triggerChars.indexOf(char) < 0)
//         || (recipientTagName.charAt(0) === 'h' && char === '\n')){

//             recipient.innerHTML = laiCleanFromTriggerSymbols(recipient.innerHTML);
//             recipient = laiChangeRecipient(char, recipient, recipientTagName);
//             recipientTagName = recipient.tagName.toLowerCase();
//             if((/^H\d$/).test(Object.values(recipient.childNodes)?.slice(-1)?.[0]?.tagName)){
//                 char = '';
//             }
//         } else if(recipientTagName === 'code' && laiWordEndings.test(currentStreamData.slice(-5))){
//             console.log(`posible wrong code tag ${recipientTagName}: ${currentStreamData.slice(-5)}`);
//             recipient = laiFixWrondCodeTag(recipient);
//             recipientTagName = recipient.tagName.toLowerCase();
//         }

//         currentStreamData += rawChar;

//         if(char === '\n' && recipientTagName === 'pre'){
//             const streamLastLine = currentStreamData.split('\n')?.slice(-3).join('\n');
//             let match = /(?:\n)(?:`{3}|'{3})([^\n]+)(?:\n)$/.exec(streamLastLine) || [];
//             if(match?.[1]){
//                 recipient.innerHTML = recipient.innerHTML.replace(new RegExp(match[1] + '$', 'ig'), '');
//                 const sourceTitle = recipient.querySelector('.lai-source-title');
//                 sourceTitle.innerHTML = sourceTitle.innerHTML.replace(new RegExp('Code', 'gi'), match[1]);
//                 char = '';
//             }
//         }

//          recipient.innerHTML +=  recipientTagName === 'pre' ? char : (char === '\n' ? '<br/>' : char);
//          recipient.innerHTML = recipient.innerHTML.replace(/<br\s*\/?>\s*<br\s*\/?>$/, '<p/>');
//    });
// }

function laiAppendSelectionToUserImput(text){
    const shadowRoot = document.getElementById('localAI').shadowRoot;
    const sideBar = shadowRoot.getElementById('laiSidebar');
    if(!sideBar){
        console.err('Sidebar not found!');
        return;
    }

    if(!sideBar.classList.contains('active')){
        laiSwapSidebarWithButton();
    }
    const userInput = sideBar.querySelector('#laiUserInput');
    userInput.value += `\n${text}`;
}

function laiResizeContainer(e) {
    e.preventDefault();
    const resizableDiv = e.target.closest('.lai-fixed-parent');
    const sidebar = resizableDiv.closest('.active');
    let isResizing = true;
    let prevX = e.clientX;
    let originalWidth = resizableDiv.getBoundingClientRect().width;

    function onMouseMove(e) {
        if (!isResizing) {  return;  }
        sidebar?.classList.add('dragging');
        const newX = e.clientX;
        const deltaX = newX - prevX;

        let newWidth = originalWidth - deltaX;

        newWidth = Math.min(newWidth, window.innerWidth);

        newWidth = Math.max(newWidth, 10);

        resizableDiv.style.width = `${newWidth}px`;

        if (newWidth >= window.innerWidth || newWidth <= 10) {
            stopResizing();
        }
    }

    function onMouseUp() {
        sidebar?.classList.remove('dragging');
        stopResizing();
    }

    function stopResizing() {
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
        isResizing = false;
    }

    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
}
